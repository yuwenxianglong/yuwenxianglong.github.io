---
title: DeePMD-kit的安装和自我启蒙
author: 赵旭山
tags: 随笔
---

笔者认为，大数据技术、机器学习技术是目前材料信息技术能够得以工程应用的最高效模式，工作之余摸索了不少相关开源代码，为避免一两年后把这些学习历程忘得一干二净，随笔点滴记录一下。

> 点滴记录，幼儿学步，不是教程。

DeePMD-kit是基于神经网络模型拟合多体势的一个优秀软件，基于TensorFlow机器学习框架开发。难能可贵的是，作者及时跟进Tensorflow 2.0版本的更新，对代码进行了迁移和更新，跟进最近科学进展的前瞻性很让笔者佩服。

#### 1. 安装篇

几个月前用conda安装过一次，但当时的代码不兼容TensorFlow 2.0，又特别不适应“`conda create -n your_env_name python=X.X`”虚拟环境这种“混乱”方式，所以简单折腾了一下放弃了。此次趁着在家抗疫的空闲，在自己的MacOS 10.15.3和Ubuntu 19.10（虚拟机）上测试进行了安装，成功运行。

笔者习惯于以conda（Miniconda）为主管理python环境，如非必要不使用pip。所以以下安装记录基于conda进行。

conda提供了DeePMD-kit的安装Source，包括以下Packages。但遗憾的是，此Source仅支持`linux-64`系统。

![](/assets/images/condaDeepmodelingSource202002221313.png)

<img src="/assets/images/deepmdOnlySupportLinux202002221318.png" style="zoom:50%;" />

##### **MacOS**

conda的“`conda forge`” channel 提供了`deepmd-kit`、`dpdata`和`dpgen`软件包，但却没有提供lammps-dp，所以deepmd-kit所得的势函数（`xxxx.pb`），是无法被常规lammps程序（conda或brew安装）读取的。

```
deepmd-kit                     1.1.3  py37h2af55cb_1  conda-forge
dpdata                        0.1.15            py_0  conda-forge
dpgen                          0.7.0            py_0  conda-forge
```

故执行：`conda install deepmd-kit dpdata dpgen -c conda-forge`即可完成安装。

自行编译deepmd-kit的lammps模块没成功🥵。

##### Ubuntu

ubuntu下deepmd-kit安装比较简单，依照官方“Readme”文件即可。

```bash
conda install deepmd-kit lammps-dp dpdata dpgen -c deepmodeling
```

没有安装GPU版本，有机会以后试试。

#### 2. 运行试试！

按照[https://github.com/deepmodeling/deepmd-kit#with-conda](https://github.com/deepmodeling/deepmd-kit#with-conda)中的README.md文件运行试试。

##### 2.1 训练模型

> "The method of training is explained in our [DeePMD](https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.120.143001) and [DeepPot-SE](https://arxiv.org/abs/1805.09003) papers. With the source code we provide a small training dataset taken  from 400 frames generated by NVT ab-initio water MD trajectory with 300  frames for training and 100 for testing. [An example training parameter file](https://github.com/deepmodeling/deepmd-kit/blob/master/examples/water/train/water_se_a.json) is provided. One can try with the training by："

```bash
$ cd $deepmd_source_dir/examples/water/train/
$ dp train water_se_a.json
```

`water_se_a.json`为输入文件，文件中各key的含义参见README.md说明。

屏幕打印的信息如下所示：

```bash
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/compat/v2_compat.py:65: disable_resource_variables (from tensorflow.python.ops.variable_scope) is deprecated and will be removed in a future version.
Instructions for updating:
non-resource variables are not supported in the long term
WARNING:root:Environment variable KMP_BLOCKTIME is empty. Use the default value 0
WARNING:root:Environment variable KMP_AFFINITY is empty. Use the default value granularity=fine,verbose,compact,1,0
# DEEPMD:  _____               _____   __  __  _____           _     _  _   
# DEEPMD: |  __ \             |  __ \ |  \/  ||  __ \         | |   (_)| |  
# DEEPMD: | |  | |  ___   ___ | |__) || \  / || |  | | ______ | | __ _ | |_ 
# DEEPMD: | |  | | / _ \ / _ \|  ___/ | |\/| || |  | ||______|| |/ /| || __|
# DEEPMD: | |__| ||  __/|  __/| |     | |  | || |__| |        |   < | || |_ 
# DEEPMD: |_____/  \___| \___||_|     |_|  |_||_____/         |_|\_\|_| \__|
# DEEPMD: 
# DEEPMD: Please read and cite:
# DEEPMD: Wang, Zhang, Han and E, Comput.Phys.Comm. 228, 178-184 (2018)
# DEEPMD: 
# DEEPMD: ---Summary of the training---------------------------------------
# DEEPMD: installed to:       /private/var/folders/vh/q3d7v_q979335fcrm08vzq080000gn/T/pip-install-97l0h97e/deepmd-kit/_skbuild/macosx-10.15-x86_64-3.7/cmake-install
# DEEPMD: source :            
# DEEPMD: source brach:       
# DEEPMD: source commit:      
# DEEPMD: source commit at:   
# DEEPMD: build float prec:   double
# DEEPMD: build with tf inc:  /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/include
# DEEPMD: build with tf lib:  
# DEEPMD: running on:         localhost
# DEEPMD: gpu per node:       None
# DEEPMD: num_inter_threads:  0
# DEEPMD: num_intra_threads:  0
# DEEPMD: -----------------------------------------------------------------
# DEEPMD: 
# DEEPMD: ---Summary of DataSystem-----------------------------------------
# DEEPMD: find 1 system(s):
# DEEPMD:                                     system  natoms  bch_sz  n_bch
# DEEPMD:                                   ../data/     192       1    300
# DEEPMD: -----------------------------------------------------------------
# DEEPMD: 
# DEEPMD: training without frame parameter
2020-02-22 18:21:37.564973: I tensorflow/core/platform/cpu_feature_guard.cc:145] This TensorFlow binary is optimized with Intel(R) MKL-DNN to use the following CPU instructions in performance critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in non-MKL-DNN operations, rebuild TensorFlow with the appropriate compiler flags.
2020-02-22 18:21:37.566335: I tensorflow/core/common_runtime/process_util.cc:115] Creating new thread pool with default inter op setting: 8. Tune using inter_op_parallelism_threads for best performance.
# DEEPMD: built lr
# DEEPMD: built network
# DEEPMD: built training
# DEEPMD: restart from model /Users/zhaoxushan/OpenCALPHAD/DeepMD_Kit/deepmd-kit/examples/water/train/model.ckpt
# DEEPMD: start training at lr 6.30e-04 (== 6.30e-04), final lr will be 3.58e-04
# DEEPMD: batch   46500 training time 35.71 s, testing time 1.97 s
# DEEPMD: batch   46600 training time 30.08 s, testing time 1.03 s
# DEEPMD: saved checkpoint model.ckpt
```

如果训练过程被中断，还可以用以下命令重启计算，大赞👍！

```bash
dp train --restart model.ckpt water_se_a.json
```

##### 2.2 保存训练好的模型

```bash
dp freeze -o graph.pb
```

屏幕打印信息为：

```bash
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/compat/v2_compat.py:65: disable_resource_variables (from tensorflow.python.ops.variable_scope) is deprecated and will be removed in a future version.
Instructions for updating:
non-resource variables are not supported in the long term
WARNING:root:Environment variable KMP_BLOCKTIME is empty. Use the default value 0
WARNING:root:Environment variable KMP_AFFINITY is empty. Use the default value granularity=fine,verbose,compact,1,0
2020-02-22 19:53:52.174514: I tensorflow/core/platform/cpu_feature_guard.cc:145] This TensorFlow binary is optimized with Intel(R) MKL-DNN to use the following CPU instructions in performance critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in non-MKL-DNN operations, rebuild TensorFlow with the appropriate compiler flags.
2020-02-22 19:53:52.177828: I tensorflow/core/common_runtime/process_util.cc:115] Creating new thread pool with default inter op setting: 8. Tune using inter_op_parallelism_threads for best performance.
The following nodes will be frozen: o_energy,o_force,o_virial,o_atom_energy,o_atom_virial,descrpt_attr/rcut,descrpt_attr/ntypes,fitting_attr/dfparam,fitting_attr/daparam,model_attr/tmap,model_attr/model_type
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/deepmd/freeze.py:91: convert_variables_to_constants (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.convert_variables_to_constants`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/deepmd/freeze.py:91: convert_variables_to_constants (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.convert_variables_to_constants`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/framework/graph_util_impl.py:275: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.extract_sub_graph`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/framework/graph_util_impl.py:275: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.extract_sub_graph`
1108 ops in the final graph.
```



##### 2.3 使用保存的多体势模型(lammps)

lammps的`in`文件设置：

```bash
pair_style			deepmd	graph.pb
```

而后，启动lammps开始计算。

```bash
lmp: Relink `/home/zhaoxushan/miniconda3/bin/../lib/./libgfortran.so.4' with `/lib/x86_64-linux-gnu/librt.so.1' for IFUNC symbol `clock_gettime'
LAMMPS (7 Aug 2019)
OMP_NUM_THREADS environment is not set. Defaulting to 1 thread. (src/comm.cpp:93)
  using 1 OpenMP thread(s) per MPI task
Reading data file ...
  triclinic box = (0 0 0) to (12.4447 12.4447 12.4447) with tilt (0 0 0)
  1 by 1 by 1 MPI processor grid
  reading atoms ...
  192 atoms
  read_data CPU = 0.00268483 secs
Summary of lammps deepmd module ...
  >>> Info of deepmd-kit:
  installed to:       /home/zhaoxushan/miniconda3
  source:             v1.1.2-10-g984ef69
  source brach:       HEAD
  source commit:      984ef69
  source commit at:   2020-01-23 22:36:57 +0800
  build float prec:   float
  build with tf inc:  /home/zhaoxushan/miniconda3/include
  build with tf lib:  /home/zhaoxushan/miniconda3/lib/libtensorflow_cc.so;/home/zhaoxushan/miniconda3/lib/libtensorflow_framework.so
  set tf intra_op_parallelism_threads: 0
  set tf inter_op_parallelism_threads: 0
  >>> Info of lammps module:
  use deepmd-kit at:  /home/zhaoxushan/miniconda3
  source:             v1.1.2-10-g984ef69
  source branch:      HEAD
  source commit:      984ef69
  source commit at:   2020-01-23 22:36:57 +0800
  build float prec:   float
  build with tf inc:  /home/zhaoxushan/miniconda3/include
  build with tf lib:  /home/zhaoxushan/miniconda3/lib/libtensorflow_cc.so;/home/zhaoxushan/miniconda3/lib/libtensorflow_framework.so
2020-02-22 20:00:32.891793: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-02-22 20:00:32.929247: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2303980000 Hz
2020-02-22 20:00:32.930590: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x564604199420 executing computations on platform Host. Devices:
2020-02-22 20:00:32.930929: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
Invalid argument: Input 0 of node DescrptSeA was passed double from Reshape_2:0 incompatible with expected float.
```



