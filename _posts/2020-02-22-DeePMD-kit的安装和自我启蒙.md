---
title: DeePMD-kitçš„å®‰è£…å’Œè‡ªæˆ‘å¯è’™
author: èµµæ—­å±±
tags: éšç¬”
---

ç¬”è€…è®¤ä¸ºï¼Œå¤§æ•°æ®æŠ€æœ¯ã€æœºå™¨å­¦ä¹ æŠ€æœ¯æ˜¯ç›®å‰ææ–™ä¿¡æ¯æŠ€æœ¯èƒ½å¤Ÿå¾—ä»¥å·¥ç¨‹åº”ç”¨çš„æœ€é«˜æ•ˆæ¨¡å¼ï¼Œå·¥ä½œä¹‹ä½™æ‘¸ç´¢äº†ä¸å°‘ç›¸å…³å¼€æºä»£ç ï¼Œä¸ºé¿å…ä¸€ä¸¤å¹´åæŠŠè¿™äº›å­¦ä¹ å†ç¨‹å¿˜å¾—ä¸€å¹²äºŒå‡€ï¼Œéšç¬”ç‚¹æ»´è®°å½•ä¸€ä¸‹ã€‚

> ç‚¹æ»´è®°å½•ï¼Œå¹¼å„¿å­¦æ­¥ï¼Œä¸æ˜¯æ•™ç¨‹ã€‚

DeePMD-kitæ˜¯åŸºäºç¥ç»ç½‘ç»œæ¨¡å‹æ‹Ÿåˆå¤šä½“åŠ¿çš„ä¸€ä¸ªä¼˜ç§€è½¯ä»¶ï¼ŒåŸºäºTensorFlowæœºå™¨å­¦ä¹ æ¡†æ¶å¼€å‘ã€‚éš¾èƒ½å¯è´µçš„æ˜¯ï¼Œä½œè€…åŠæ—¶è·Ÿè¿›Tensorflow 2.0ç‰ˆæœ¬çš„æ›´æ–°ï¼Œå¯¹ä»£ç è¿›è¡Œäº†è¿ç§»å’Œæ›´æ–°ï¼Œè·Ÿè¿›æœ€è¿‘ç§‘å­¦è¿›å±•çš„å‰ç»æ€§å¾ˆè®©ç¬”è€…ä½©æœã€‚

#### 1. å®‰è£…ç¯‡

å‡ ä¸ªæœˆå‰ç”¨condaå®‰è£…è¿‡ä¸€æ¬¡ï¼Œä½†å½“æ—¶çš„ä»£ç ä¸å…¼å®¹TensorFlow 2.0ï¼Œåˆç‰¹åˆ«ä¸é€‚åº”â€œ`conda create -n your_env_name python=X.X`â€è™šæ‹Ÿç¯å¢ƒè¿™ç§â€œæ··ä¹±â€æ–¹å¼ï¼Œæ‰€ä»¥ç®€å•æŠ˜è…¾äº†ä¸€ä¸‹æ”¾å¼ƒäº†ã€‚æ­¤æ¬¡è¶ç€åœ¨å®¶æŠ—ç–«çš„ç©ºé—²ï¼Œåœ¨è‡ªå·±çš„MacOS 10.15.3å’ŒUbuntu 19.10ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸Šæµ‹è¯•è¿›è¡Œäº†å®‰è£…ï¼ŒæˆåŠŸè¿è¡Œã€‚

ç¬”è€…ä¹ æƒ¯äºä»¥condaï¼ˆMinicondaï¼‰ä¸ºä¸»ç®¡ç†pythonç¯å¢ƒï¼Œå¦‚éå¿…è¦ä¸ä½¿ç”¨pipã€‚æ‰€ä»¥ä»¥ä¸‹å®‰è£…è®°å½•åŸºäºcondaè¿›è¡Œã€‚

condaæä¾›äº†DeePMD-kitçš„å®‰è£…Sourceï¼ŒåŒ…æ‹¬ä»¥ä¸‹Packagesã€‚ä½†é—æ†¾çš„æ˜¯ï¼Œæ­¤Sourceä»…æ”¯æŒ`linux-64`ç³»ç»Ÿã€‚

![](/assets/images/condaDeepmodelingSource202002221313.png)

<img src="/assets/images/deepmdOnlySupportLinux202002221318.png" style="zoom:50%;" />

##### **MacOS**

condaçš„â€œ`conda forge`â€ channel æä¾›äº†`deepmd-kit`ã€`dpdata`å’Œ`dpgen`è½¯ä»¶åŒ…ï¼Œä½†å´æ²¡æœ‰æä¾›lammps-dpï¼Œæ‰€ä»¥deepmd-kitæ‰€å¾—çš„åŠ¿å‡½æ•°ï¼ˆ`xxxx.pb`ï¼‰ï¼Œæ˜¯æ— æ³•è¢«å¸¸è§„lammpsç¨‹åºï¼ˆcondaæˆ–brewå®‰è£…ï¼‰è¯»å–çš„ã€‚

```
deepmd-kit                     1.1.3  py37h2af55cb_1  conda-forge
dpdata                        0.1.15            py_0  conda-forge
dpgen                          0.7.0            py_0  conda-forge
```

æ•…æ‰§è¡Œï¼š`conda install deepmd-kit dpdata dpgen -c conda-forge`å³å¯å®Œæˆå®‰è£…ã€‚

è‡ªè¡Œç¼–è¯‘deepmd-kitçš„lammpsæ¨¡å—æ²¡æˆåŠŸğŸ¥µã€‚

##### Ubuntu

ubuntuä¸‹deepmd-kitå®‰è£…æ¯”è¾ƒç®€å•ï¼Œä¾ç…§å®˜æ–¹â€œReadmeâ€æ–‡ä»¶å³å¯ã€‚

```bash
conda install deepmd-kit lammps-dp dpdata dpgen -c deepmodeling
```

æ²¡æœ‰å®‰è£…GPUç‰ˆæœ¬ï¼Œæœ‰æœºä¼šä»¥åè¯•è¯•ã€‚

#### 2. è¿è¡Œè¯•è¯•ï¼

æŒ‰ç…§[https://github.com/deepmodeling/deepmd-kit#with-conda](https://github.com/deepmodeling/deepmd-kit#with-conda)ä¸­çš„README.mdæ–‡ä»¶è¿è¡Œè¯•è¯•ã€‚

##### 2.1 è®­ç»ƒæ¨¡å‹

> "The method of training is explained in our [DeePMD](https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.120.143001) and [DeepPot-SE](https://arxiv.org/abs/1805.09003) papers. With the source code we provide a small training dataset taken  from 400 frames generated by NVT ab-initio water MD trajectory with 300  frames for training and 100 for testing. [An example training parameter file](https://github.com/deepmodeling/deepmd-kit/blob/master/examples/water/train/water_se_a.json) is provided. One can try with the training byï¼š"

```bash
$ cd $deepmd_source_dir/examples/water/train/
$ dp train water_se_a.json
```

`water_se_a.json`ä¸ºè¾“å…¥æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­å„keyçš„å«ä¹‰å‚è§README.mdè¯´æ˜ã€‚

å±å¹•æ‰“å°çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/compat/v2_compat.py:65: disable_resource_variables (from tensorflow.python.ops.variable_scope) is deprecated and will be removed in a future version.
Instructions for updating:
non-resource variables are not supported in the long term
WARNING:root:Environment variable KMP_BLOCKTIME is empty. Use the default value 0
WARNING:root:Environment variable KMP_AFFINITY is empty. Use the default value granularity=fine,verbose,compact,1,0
# DEEPMD:  _____               _____   __  __  _____           _     _  _   
# DEEPMD: |  __ \             |  __ \ |  \/  ||  __ \         | |   (_)| |  
# DEEPMD: | |  | |  ___   ___ | |__) || \  / || |  | | ______ | | __ _ | |_ 
# DEEPMD: | |  | | / _ \ / _ \|  ___/ | |\/| || |  | ||______|| |/ /| || __|
# DEEPMD: | |__| ||  __/|  __/| |     | |  | || |__| |        |   < | || |_ 
# DEEPMD: |_____/  \___| \___||_|     |_|  |_||_____/         |_|\_\|_| \__|
# DEEPMD: 
# DEEPMD: Please read and cite:
# DEEPMD: Wang, Zhang, Han and E, Comput.Phys.Comm. 228, 178-184 (2018)
# DEEPMD: 
# DEEPMD: ---Summary of the training---------------------------------------
# DEEPMD: installed to:       /private/var/folders/vh/q3d7v_q979335fcrm08vzq080000gn/T/pip-install-97l0h97e/deepmd-kit/_skbuild/macosx-10.15-x86_64-3.7/cmake-install
# DEEPMD: source :            
# DEEPMD: source brach:       
# DEEPMD: source commit:      
# DEEPMD: source commit at:   
# DEEPMD: build float prec:   double
# DEEPMD: build with tf inc:  /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/include
# DEEPMD: build with tf lib:  
# DEEPMD: running on:         localhost
# DEEPMD: gpu per node:       None
# DEEPMD: num_inter_threads:  0
# DEEPMD: num_intra_threads:  0
# DEEPMD: -----------------------------------------------------------------
# DEEPMD: 
# DEEPMD: ---Summary of DataSystem-----------------------------------------
# DEEPMD: find 1 system(s):
# DEEPMD:                                     system  natoms  bch_sz  n_bch
# DEEPMD:                                   ../data/     192       1    300
# DEEPMD: -----------------------------------------------------------------
# DEEPMD: 
# DEEPMD: training without frame parameter
2020-02-22 18:21:37.564973: I tensorflow/core/platform/cpu_feature_guard.cc:145] This TensorFlow binary is optimized with Intel(R) MKL-DNN to use the following CPU instructions in performance critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in non-MKL-DNN operations, rebuild TensorFlow with the appropriate compiler flags.
2020-02-22 18:21:37.566335: I tensorflow/core/common_runtime/process_util.cc:115] Creating new thread pool with default inter op setting: 8. Tune using inter_op_parallelism_threads for best performance.
# DEEPMD: built lr
# DEEPMD: built network
# DEEPMD: built training
# DEEPMD: restart from model /Users/zhaoxushan/OpenCALPHAD/DeepMD_Kit/deepmd-kit/examples/water/train/model.ckpt
# DEEPMD: start training at lr 6.30e-04 (== 6.30e-04), final lr will be 3.58e-04
# DEEPMD: batch   46500 training time 35.71 s, testing time 1.97 s
# DEEPMD: batch   46600 training time 30.08 s, testing time 1.03 s
# DEEPMD: saved checkpoint model.ckpt
```

å¦‚æœè®­ç»ƒè¿‡ç¨‹è¢«ä¸­æ–­ï¼Œè¿˜å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤é‡å¯è®¡ç®—ï¼Œå¤§èµğŸ‘ï¼

```bash
dp train --restart model.ckpt water_se_a.json
```

##### 2.2 ä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹

```bash
dp freeze -o graph.pb
```

å±å¹•æ‰“å°ä¿¡æ¯ä¸ºï¼š

```bash
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/compat/v2_compat.py:65: disable_resource_variables (from tensorflow.python.ops.variable_scope) is deprecated and will be removed in a future version.
Instructions for updating:
non-resource variables are not supported in the long term
WARNING:root:Environment variable KMP_BLOCKTIME is empty. Use the default value 0
WARNING:root:Environment variable KMP_AFFINITY is empty. Use the default value granularity=fine,verbose,compact,1,0
2020-02-22 19:53:52.174514: I tensorflow/core/platform/cpu_feature_guard.cc:145] This TensorFlow binary is optimized with Intel(R) MKL-DNN to use the following CPU instructions in performance critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in non-MKL-DNN operations, rebuild TensorFlow with the appropriate compiler flags.
2020-02-22 19:53:52.177828: I tensorflow/core/common_runtime/process_util.cc:115] Creating new thread pool with default inter op setting: 8. Tune using inter_op_parallelism_threads for best performance.
The following nodes will be frozen: o_energy,o_force,o_virial,o_atom_energy,o_atom_virial,descrpt_attr/rcut,descrpt_attr/ntypes,fitting_attr/dfparam,fitting_attr/daparam,model_attr/tmap,model_attr/model_type
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/deepmd/freeze.py:91: convert_variables_to_constants (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.convert_variables_to_constants`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/deepmd/freeze.py:91: convert_variables_to_constants (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.convert_variables_to_constants`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/framework/graph_util_impl.py:275: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.extract_sub_graph`
WARNING:tensorflow:From /usr/local/Caskroom/miniconda/base/lib/python3.7/site-packages/tensorflow_core/python/framework/graph_util_impl.py:275: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.compat.v1.graph_util.extract_sub_graph`
1108 ops in the final graph.
```



##### 2.3 ä½¿ç”¨ä¿å­˜çš„å¤šä½“åŠ¿æ¨¡å‹(lammps)

lammpsçš„`in`æ–‡ä»¶è®¾ç½®ï¼š

```bash
pair_style			deepmd	graph.pb
```

è€Œåï¼Œå¯åŠ¨lammpså¼€å§‹è®¡ç®—ã€‚

```bash
lmp: Relink `/home/zhaoxushan/miniconda3/bin/../lib/./libgfortran.so.4' with `/lib/x86_64-linux-gnu/librt.so.1' for IFUNC symbol `clock_gettime'
LAMMPS (7 Aug 2019)
OMP_NUM_THREADS environment is not set. Defaulting to 1 thread. (src/comm.cpp:93)
  using 1 OpenMP thread(s) per MPI task
Reading data file ...
  triclinic box = (0 0 0) to (12.4447 12.4447 12.4447) with tilt (0 0 0)
  1 by 1 by 1 MPI processor grid
  reading atoms ...
  192 atoms
  read_data CPU = 0.00268483 secs
Summary of lammps deepmd module ...
  >>> Info of deepmd-kit:
  installed to:       /home/zhaoxushan/miniconda3
  source:             v1.1.2-10-g984ef69
  source brach:       HEAD
  source commit:      984ef69
  source commit at:   2020-01-23 22:36:57 +0800
  build float prec:   float
  build with tf inc:  /home/zhaoxushan/miniconda3/include
  build with tf lib:  /home/zhaoxushan/miniconda3/lib/libtensorflow_cc.so;/home/zhaoxushan/miniconda3/lib/libtensorflow_framework.so
  set tf intra_op_parallelism_threads: 0
  set tf inter_op_parallelism_threads: 0
  >>> Info of lammps module:
  use deepmd-kit at:  /home/zhaoxushan/miniconda3
  source:             v1.1.2-10-g984ef69
  source branch:      HEAD
  source commit:      984ef69
  source commit at:   2020-01-23 22:36:57 +0800
  build float prec:   float
  build with tf inc:  /home/zhaoxushan/miniconda3/include
  build with tf lib:  /home/zhaoxushan/miniconda3/lib/libtensorflow_cc.so;/home/zhaoxushan/miniconda3/lib/libtensorflow_framework.so
2020-02-22 20:00:32.891793: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
2020-02-22 20:00:32.929247: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2303980000 Hz
2020-02-22 20:00:32.930590: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x564604199420 executing computations on platform Host. Devices:
2020-02-22 20:00:32.930929: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
Invalid argument: Input 0 of node DescrptSeA was passed double from Reshape_2:0 incompatible with expected float.
```



